---
category: blog
layout: post
date: 2015-01-17T02:16:09+09:00
tags: [ "haskell", "clean" ]
---

# 状態と参照透明性

-   状態は難しい
    -   変数
    -   入出力
-   難しいなら無くしてしまえばよい
    -   状態を排除
    -   参照透明性
-   言語処理系の外側の状態はどうしようもないので
    -   一意型
    -   モナド

<!-- more -->

## 状態は難しい
状態は難しい。

例えば[変数](http://ja.wikipedia.org/wiki/%E5%A4%89%E6%95%B0_%28%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0%29)。変数の値が自由に変更可能なら、ある変数を使用する際には、その変数を変更可能な全ての場所を考慮しなければならない。

global変数のようなスコープの広すぎる変数で混乱した、確保した領域を二重に開放するコードを書いた、といった経験は皆あるはずである。

## 難しいなら無くしてしまえばよい
状態の問題を解決したい。その手段の1つとして、状態を無くしてしまえばよい、という極端なものがある。

変数を無くしてしまう。外部の状態の利用、つまりファイルの操作だとかは当然禁止する。
変数を無くしてもチューリング完全の意味で計算できる範囲に影響はない[^1]ので問題はない。

そうすると、どの関数も、引数が同じならいつ計算しても値が同じになる。
これによって、どの関数も自由にメモ化できる、その値を使わないなら計算しなくてもよい、並行/並列化しやすい、などの良い性質が得られる。
加えて、式を見ればその定義以外の場所を見なくても値が分かるので楽である。

### 用語
式の値がその構成要素によってのみ決まる性質を[参照透明性](http://ja.wikipedia.org/wiki/%E5%8F%82%E7%85%A7%E9%80%8F%E9%81%8E%E6%80%A7)と呼ぶ。参照透明性を壊す作用を[副作用](http://ja.wikipedia.org/wiki/%E5%89%AF%E4%BD%9C%E7%94%A8_%28%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%29)と呼ぶ。値が引数によってのみ決まりかつ副作用を持たない関数を[純粋関数](http://en.wikipedia.org/wiki/Pure_function)と呼び、参照透明性が成り立つ言語を純粋関数型言語と呼ぶ[^2]。
ある式の値を使う直前まで評価しないという評価戦略を[遅延評価](http://ja.wikipedia.org/wiki/%E9%81%85%E5%BB%B6%E8%A9%95%E4%BE%A1)と呼び[^3]、これは参照透明性と相性が良い[^4]。

## 言語処理系の外側の状態はどうしようもないので
そうはいってもファイル操作すらできないとなると実用は難しい。
どうにかして利用したいが、参照透明性は美味しいので手放したくない。

解決策として、引数を毎回変えるというものがある。引数が同じなら結果が同じという性質を保ちたいのだから、外部の状態に依存する関数は引数を毎回変えればよいのである。
この策を採用し、引数を毎回変えることを強制する手段として[一意型](http://en.wikipedia.org/wiki/Uniqueness_type)というものを使う言語に[Clean](http://wiki.clean.cs.ru.nl/Clean)がある。

別の解決策として、外部の状態に依存する関数も排除するというものがある。それが関数でなければ参照透明性は壊さない。副作用を適切に隔離しそれを合成してプログラムを作る。
この策を採用し、副作用を操作し合成する枠組みとして[モナド](http://ja.wikipedia.org/wiki/%E3%83%A2%E3%83%8A%E3%83%89_%28%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0%29)というものを採用した[^5]言語に[Haskell](https://www.haskell.org/haskellwiki/Haskell)がある。


## 関連する読み物
-   [プログラミング言語論2012 #6 関数型言語](http://www2.gssm.otsuka.tsukuba.ac.jp/staff/kuno/lectures/12/2012-04-TopicsPL6.pdf)
-   [Clean 一意型 調査メモ - Qiita](http://qiita.com/7shi/items/ab3b819871d7b0710949)
-   [Haskellには副作用がないのか？ - あどけない話](http://d.hatena.ne.jp/kazu-yamamoto/20090627/1246135829)


---

# 状態と参照透明性

[^1]: 結論を証拠に挙げるようではあるが、Haskell等を触ったことがあれば、問題ないことは分かるはず。詳しくは計算論を学ぼう。
[^2]: 一方で関数型言語という言葉に関しては明確な定義はない。
[^3]: 式を関数抽象で包むことでその評価をその関数の適用時にずらすことはできるが、それは遅延評価とは呼ばない。そもそも評価戦略でない。
[^4]: 当然ながら、相性が良いだけで必須でない。
[^5]: 必ずしもその枠組みとしてモナドを利用する必要はない。
