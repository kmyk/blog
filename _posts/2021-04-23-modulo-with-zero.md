---
category: blog
layout: post
date: 2021-04-23T00:00:00+09:00
noindex: true
---

# mod で計算するときに零の重複度も持つテク

## 概要

通常の整数の乗除算を、計算過程に出現する数の最大値を小さくするなどの目的で、ある $m$ に対して $\bmod~ m$ で計算することがあります。
しかし、$m$ が途中に出現する数より小さい場合には、もともとは $0$ ではないのだが $\bmod~ m$ では $0$ になってしまう数が問題となることがあります。
このような場合には、整数 $a$ に対して $b = a ~\bmod~ m$ の値だけでなく、その整数 $a$ が約数として $m$ をいくつ含むかの数 $c$ も管理するとうまくいくことがあります。
つまり $a = b m^c$ に対して単に $b$ のみでなく組 $(b, c)$ を持つようにするとうまくいくことがあります。
また、計算の過程では $c \lt 0$ のような組 $(b, c)$ を許して考えると便利です。


## 例題 1: AtCoder Regular Contest 117: C - Tricolor Pyramid

URL: <https://atcoder.jp/contests/arc117/tasks/arc117_c>

この問題の想定解法は以下のふたつのパートに分かれています。

1.  mod 文字種で考えて立式する
2.  ${} _ n C _ r ~\bmod~ 3$ をたくさん高速に計算する

今回議論するのは後者の部分です。
これは通常の ${} _ n C _ r ~\bmod~ (10^9+7)$ など場合と同様にはできません。
${} _ n C _ r = \frac{n!}{r! \cdot (n-r)!}$ という関係式を使って ${} _ n C _ r ~\bmod~ 3$ を計算するとき、右辺の除算の上下に $0$ が出てきてしまうことがあるためです。
たとえば ${} _ 5 C _ 3 ~\bmod~ 3 = 20 ~\bmod~ 3 = 2$ を計算したいときに $\frac{5!}{3! \cdot (5 - 3)!} = \frac{0}{0 \cdot 2}$ となって計算ができません。

そこで今回のテクを使います。
通常は $\bmod~ m$ での階乗 $a_n = n! ~\bmod~ m$ を事前に計算しますが、今回の場合は $n! = b_n m^{c_n}$ とおいて組 $(b_n ~\bmod~ m, c_n)$ を事前に計算して持っておきます。
そしてこの組の上で適切に演算をします。
たとえば ${} _ 5 C _ 3  ~\bmod~ 3$ を計算したいときを考えましょう。
$5! = 40 \cdot 3^1$ かつ $3! = 2 \cdot 3^1$ かつ $2! = 2 \cdot 3^0$ でありまた $40 \equiv 1 \pmod{3}$ かつ $2^{-1} \equiv 2 \pmod{3}$ であるので $\frac{5!}{3! \cdot (5 - 3)!} \equiv \frac{(1, 1)}{(2, 1) \cdot (2, 0)} = (1, 1) \cdot (2, -1) \cdot (2, 0) = (1, 0) \equiv 1$ と計算ができます。

## 例題 2: yukicoder No.1141 田グリッド

URL: <https://yukicoder.me/problems/no/1141>

これは次のような問題です。

-   $H \times W$ の行列 $A$ (ただし $0 \le A _ {y, x} \le 10^9$) が与えられる。次のようなクエリ $(r_i, c_i)$ がたくさん与えられるのですべて処理せよ: $A$ から $r_i$ 行目と $c_i$ 列目を削除してできる $(H - 1) \times (W - 1)$ 行列の要素の総積 $\mathrm{ans} _ i = \prod _ {y \ne r_i} \prod _ {x \ne c_i} A _ {y, x} ~\bmod~ (10^9+7)$ を答えよ。

この問題を解くための方法として、包除原理を用いたようなものがまず思い付くでしょう。
つまり、全体の総積 $f = \prod _ y \prod _ x A _ {y, x}$ と各行の総積 $g_y = \prod _ x A _ {y, x}$ と各列の総積 $h_x = \prod _ y A _ {y, x}$ とを事前に計算しておき、$\mathrm{ans} _ i = f \cdot g _ {r_i} ^ {-1} \cdot h _ {c_i} ^ {-1} \cdot A _ {r_i, c_i} ~\bmod~ (10^9+7)$ とする、というものです。
しかしこれはそのままではうまくいきません。
制約から $A _ {y, x} = 0$ が入力されることがあり、$g _ {r_i} ^ {-1}$ や $h _ {c_i} ^ {-1}$ が計算できないことがあるためです。

そこで今回のテクを使います。
入力中の $A _ {y, x} = 0$ を $10^9 + 7$ だったと思えば今回のテクを使うことができます。
$(H - 1) \times (W - 1)$ 行列中にひとつでも $0$ が含まれれば $\mathrm{ans} _ i = 0$ であり、そうでなければ $0$ を無視して (つまり $1$ で置き換えて) 計算した結果が $\mathrm{ans} _ i$ です。


## 理論

$m$ を素数とし $a = b m^c$ (ただし $m \nmid b$) に対する組 $(b, c)$ に適切な演算を入れたものは、体 $\mathbb{Z}/m\mathbb{Z}$ の有理関数体 $\mathbb{Z}/m\mathbb{Z}(x)$ の $0$ でない単項式全体を $x = m$ という想定の下で考えているものだと思えます。
ただしここで単項式とは、係数 $b \in \mathbb{Z}/m\mathbb{Z}$ と整数 $c \in \mathbb{Z}$ に対して $b x^c$ と書ける項のことです[^monomial]。
つまり今回のテクで用いられる組 $(b, c)$ は単項式 $b x^c \in \mathbb{Z}/m\mathbb{Z}(x)$ (ただし $b \not\equiv 0\pmod m$) です。
$0$ でない単項式 $b x^c$ から $a ~\bmod~ m$ の値を取り出すときは $b m^c ~\bmod~ m$ の値を計算する、つまり $c = 0$ ならば $a ~\bmod~ m = b$ であり $c \ne 0$ ならば $a ~\bmod~ m = 0$ となります。

有理関数体 $$\mathbb{Z} / m\mathbb{Z}(x)$$ の $0$ でない単項式の全体 $\lbrace b x^c \mid b \in (\mathbb{Z}/m\mathbb{Z})^{\times} \land c \in \mathbb{Z} \rbrace \subseteq \mathbb{Z}/m\mathbb{Z}(x) $ は乗法について群をなします。
演算は $b_1 x^{c_1} \cdot b_2 x^{c_2} = b_1 b_2 x^{c_1 + c_2}$ です。
単位元は $1 \cdot x^0$ であり、逆元は $b \in (\mathbb{Z}/m\mathbb{Z})^{\times}$ であることを使って $(b x^c)^{-1} = (b^{-1}) x^{-c}$ です。
なお、明らかに加法では閉じておらず、環にはなりません。


## 参考文献

-   雪江明彦, [代数学2 環と体とガロア理論](https://www.amazon.co.jp/dp/4535786607)
    -   p9 の単項式のあたりと p41 有理関数体のあたりを参考にした


## クレジット

この記事は私と [@elliptic_shiho](https://twitter.com/elliptic_shiho) との間での議論をまとめたものです。
テクニックとしての整理は私が行い、その背景の理論として有理関数体 $\mathbb{Z}/m\mathbb{Z}(x)$ を使うアイデアは [@elliptic_shiho](https://twitter.com/elliptic_shiho) が出しました。


## 注釈

[^monomial]: 「$0$ は単項式に含む」「$2x$ などは単項式に含む」「(Laurent 多項式の文脈であるので) $x^{-1}$ などは単項式に含む」という定義になっています。$0$ を単項式に含まないように定義される場合や $2x$ などを単項式に含まないように定義される場合もあることには注意してください。
